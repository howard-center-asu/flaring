---
title: "nd_flaring_and_venting"
author: "Isaac Stone Simonelli"
date: "12/10/2021"
output: 
   html_document:
     code_download: true
     code_folding: show
     toc: true
     toc_float: true
     df_print: paged
     theme: united
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(lubridate)
library(readxl)
library(gt)
library(sf)

#this is an attempt to get rid of the scientific notation problem when reading in Excel files. I have no idea if it will work .
options (scipen = 999)

load("north_dakota_orig.Rda")

```


# Introduction 

This notebook contains the analysis of North Dakota's flaring and venting data for the Howard Center Investigation, "....". As part of the investigation, we collected flaring and venting volumes reported by oil and gas companies to state regulators. We then compared annual totals for each state to what was recorded by a U.S. satellite equipped with a Visible Infrared Imaging Radiometer Suite (VIIRS) instrument. (To learn more about the satellite and our analysis of the data it collected, see [this](....) notebook). 

Companies in North Dakota are required to report their flaring data on a monthly basis, venting is only allowed for certain emergencies and maintenance.This flaring information is compiled by the state into a monthly form on the ND Department of Mineral Resources's website. 

Downloaded data from: the ND Department of Mineral Resources websiteâ€™s Monthly Production Report Index (https://www.dmr.nd.gov/oilgas/mprindex.asp). 

The data was downloaded, cleaned, and duplicates (using the DMR's criteria) were removed.



# Analysis


There are three claims made in the North Dakota summary that are supported by the findings from analyzing the state reported data.


The story states: Flared gas volumes, as reported to the state: 991,443,446,000 cubic feet

The story states: "It produces more than 438 million barrels of oil in 2020, while reportedly flaring more than 991 billion cubic feet of gas, according to state records."

The story states: From 2012 to 2020, producers in North Dakota reported just under one trillion cubic feet of gas flared, according to a Howard Center analysis. Remember, the totals below are in MCF.


```{r flare_totals}


nd_master %>%
  group_by ( year = year(report_date)) %>%
  summarise ( flaring = sum(flared, na.rm = TRUE))  %>%
  gt::gt ( ) %>%
  gt::fmt_number( columns= c(flaring), use_seps=T, decimals=0) %>%
  grand_summary_rows(fns = list("total" = "sum"),
                     columns = ("flaring"),
                     formatter=gt::fmt_number, 
                           decimals=0)


```










## Determine What Flaring Comes from Indian Country

So, we're interest in seeing if there is a disproportionate amount of flaring inside the Fort Berthold Reservation. To do this, we've went ahead and downloaded the shape files created by our GIS team from Federal and Native lands here: https://drive.google.com/file/d/1eTy7nXjNCbsj3xJ6Klofe9zs5geF93am/view?usp=sharing. I unzipped the native american areas to its own folder in this project. 

I am selecting just the data elements that will be useful in a join. 


This is a little odd because there are some of the older items that didn't have latitude and longitude in the original. In this case, we'll just take items that have flaring amounts, even if they're negative. THen see if any of the lat-long are missing. Here, we'll get one latitude and longitude for each location, removing those that don't have any. 



```{r}

last_locations <-
  nd_master %>%
  filter ( !is.na( lat)) %>%
  arrange ( api_wellno, lat ) %>%
  group_by (api_wellno) %>%
  select ( api_wellno, last_lat = lat, last_long = long) %>%
  slice_tail () %>%
  ungroup()



```


Read in the polygons for Native American lands from the Census, provided by the US National Atlas, and saved by our team in a Google drive. I downloaded just the Native American shapefile from there into a folder called `native_am_areas`.  In this case, I'm only saving some of the variables that were in the original, removing things like the security and source notations. 


This is converting it to National Atlas Equal Area projection, which is what everyone is using for the Howard Center. 

```{r}

native_fed_land <- st_read("native_am_areas/GU_Native_Am_Area.shp")  %>%
  select ( OBJECTID, NAME, AREASQKM, GNIS_ID, GNIS_NAME, FTYPE, NATIVEAMER, POPULATION, geometry) %>%
  st_transform ( crs = 2163)

```

NOTE TO ISAAC: Simple features is fine for almost everything we do - it's just a way to simplify some of the most detailed boundaries, and to hold it in a simplified fashion. I've never used anything other than that.  The difference is pretty minor between NAD83 (4269) and WGS84 (4326)


## Converting and Joining Spacial Data Sets

The first step to joining our codes is getting all the coordinates to be working on the same system. Our state data came in WGS84 while the federal and Native lands came in NAD83. ISAAC: Are you sure about this? It's not typical in the US, just in global data. 



```{r}

wells_as_map  <- st_as_sf(last_locations, coords=c("last_long", "last_lat"),
                            crs=4269, # Assuming NAD83, but it could be wrong.
                           remove=FALSE) %>% 
                 st_transform(crs = 2163) #This is the code for US National Atlas Equal Area project (above)


```


Now, tag each well as in or out of a native american area. 



```{r}

wells_with_native_am_area <- st_join (wells_as_map, native_fed_land) %>%
  clean_names() %>%
  mutate ( in_out_native_american = if_else ( is.na(name), "Not on Native American land", name )) %>%
  select ( api_wellno:geometry, in_out_native_american) %>%
  as.data.frame()

```



Now, join it back to the original by well: 

```{r join_to_flare_data}

nd_with_native_land <- 
  nd_master %>%
  left_join ( wells_with_native_am_area, by="api_wellno") %>%
  select ( report_date:file_name, last_lat:in_out_native_american )




```


This will be missing for the tag for Native American land if the well never had a lat-long in the original data. 


## Flaring Volumes on Tribal Lands


There' no harm in keeping it as an sf data frame, since it does all the same things as a regular data frame. 


```{r flaring_reservations}

nd_with_native_land %>%
  group_by (year = year(report_date),  in_out_native_american) %>%
  summarise ( flare_by_type = sum(flared, na.rm=T), .groups="drop_last") %>%
  mutate ( annual_total = sum(flare_by_type, na.rm=T), 
            pct_native = flare_by_type / annual_total ) %>%
  ungroup()  %>% 
  select (-annual_total) %>%
  gt (groupname_col = "year" ) %>%
  summary_rows (groups = TRUE, columns=c(pct_native, flare_by_type), fns = list( ~ sum(.)) , 
                formatter = fmt_number, 
                use_seps = TRUE, decimals=0)%>%
  fmt_number (flare_by_type, use_seps=TRUE, decimals=0) %>%
  fmt_percent ( pct_native, decimals=1) %>%
    cols_label (in_out_native_american = "Type of land", 
              pct_native = "% of annual total", 
              flare_by_type = "Flared") 
  




```


(We're not worried about the NA here. This just means that that flaring wasn't on the tribal land we're interested in.) The proportion went way up in 2017, then has stayed ata bout one-quarter. 


## Companies Flaring on Tribal Land

Which companies are doing the most flaring on the Fort Berthold Reservation? 

```{r ft_berthold_amounts}

nd_with_native_land %>%
  select (company, in_out_native_american, flared, report_date) %>%
  mutate ( clean_company = toupper( str_replace_all ( company, "[-,.]", "")), 
           ft_berthold = if_else (str_detect (in_out_native_american, "Fort Bert") , 
                                  "In Fort Berthold", "Not in Fort Berthold")) %>%
  group_by ( company, ft_berthold) %>%
  summarise ( flared = sum(flared, na.rm=T), .groups="drop_last") %>%
  mutate ( pct = flared / sum(flared)) %>%
  ungroup() %>% 
  filter ( ft_berthold == "In Fort Berthold") %>%
  arrange ( desc (flared))



```
